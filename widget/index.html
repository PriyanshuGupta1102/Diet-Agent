<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DietAI Chatbot</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div id="dietai-widget-container">
        <div class="chat-widget" id="chat-widget">
            <div class="chat-header" id="chat-header">
                <h2>üçè DietAI</h2>
                <button class="close-btn" id="close-btn">√ó</button>
            </div>
            <div class="chat-messages" id="chat-messages"></div>
            <form class="chat-input-form" id="chat-form">
                <input type="text" id="chat-input" placeholder="Ask about nutrition..." autocomplete="off">
                <button type="submit">Send</button>
            </form>
            <div class="resize-handle"></div>
        </div>
        <div class="chat-bubble" id="chat-bubble">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="32px" height="32px"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"></path></svg>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatWidget = document.getElementById('chat-widget');
            const chatHeader = document.getElementById('chat-header');
            const chatBubble = document.getElementById('chat-bubble');
            const closeBtn = document.getElementById('close-btn');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const messagesContainer = document.getElementById('chat-messages');

            const sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
            const API_URL = 'http://localhost:8000/chat';

            // --- UPDATED LOGIC ---
            chatBubble.addEventListener('click', () => {
                chatWidget.classList.toggle('open');
                chatBubble.style.opacity = '0';
                chatBubble.style.pointerEvents = 'none';
            });

            closeBtn.addEventListener('click', () => {
                chatWidget.classList.remove('open');
                chatBubble.style.opacity = '1';
                chatBubble.style.pointerEvents = 'auto';
            });
            
            addMessage('assistant', "Hi! I'm DietAI. How can I help you today?");

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const messageText = chatInput.value.trim();
                if (!messageText) return;

                addMessage('user', messageText);
                chatInput.value = '';
                
                try {
                    addMessage('assistant', '...', true);
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: messageText, session_id: sessionId })
                    });

                    if (!response.ok) throw new Error('Network response was not ok.');
                    
                    const data = await response.json();
                    updateTypingIndicator(data.response);

                } catch (error) {
                    console.error('Error:', error);
                    updateTypingIndicator('Sorry, something went wrong. Please try again.');
                }
            });

            function addMessage(sender, text, isTyping = false) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', `${sender}-message`);
                if (isTyping) {
                    messageElement.classList.add('typing-indicator');
                    messageElement.innerHTML = '<span>.</span><span>.</span><span>.</span>';
                } else {
                    messageElement.innerHTML = marked.parse(text);
                }
                messagesContainer.appendChild(messageElement);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            function updateTypingIndicator(text) {
                const indicator = document.querySelector('.typing-indicator');
                if (indicator) {
                    indicator.innerHTML = marked.parse(text);
                    indicator.classList.remove('typing-indicator');
                }
            }

            let isDragging = false;
            let offsetX, offsetY;

            chatHeader.addEventListener('mousedown', (e) => {
                isDragging = true;
                offsetX = e.clientX - chatWidget.getBoundingClientRect().left;
                offsetY = e.clientY - chatWidget.getBoundingClientRect().top;
                chatHeader.style.cursor = 'grabbing';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const x = e.clientX - offsetX;
                const y = e.clientY - offsetY;
                chatWidget.style.left = `${x}px`;
                chatWidget.style.top = `${y}px`;
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                chatHeader.style.cursor = 'grab';
                document.body.style.userSelect = '';
            });
        });
    </script>
</body>
</html>